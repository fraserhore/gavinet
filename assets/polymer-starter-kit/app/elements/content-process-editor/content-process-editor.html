<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="/polymer-starter-kit/app/bower_components/polymer/polymer.html">
<link rel="import" href="../mxgraph-import/mxgraph-import.html">

<dom-module id="content-process-editor">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <iron-ajax
      id="getChildren"
      auto
      url="/content/getProcess/{{identityNodeId}}?versionValidityDate={{versionValidityDate}}"
      params=''
      handle-as="json"
      last-response="{{children}}"
      on-response="_updateChildren"
      debounce-duration="300"></iron-ajax>

    <iron-ajax id="postData"
      url="/content/{{formData.action}}"
      content-type="application/json"
      method="POST"
      body="{{formData}}"
      handle-as="json"
      last-response="{{res}}"
      debounce-duration="300"></iron-ajax>

    <iron-ajax
      id="deleteRequest"
      url=""
      handle-as="json"
      on-response="deleteResponse"
      debounce-duration="300"></iron-ajax>


    <div id="page">
      <span id="mainActions" style="width:100%;padding-top:8px;padding-left:24px;padding-bottom:8px;"></span>
      <span id="selectActions" style="width:100%;padding-left:54px;padding-bottom:4px;"></span>
      <span id="zoomActions" style="width:100%;padding-left:54px;padding-top:4px;"></span>
      <div id="toolbar" style="width:16px;padding-left:20px;" valign="top"></div>
      <div id="graph" style="position:relative;height:480px;width:684px;overflow:hidden;cursor:default;">
        <!-- Graph Here -->
        <center id="splash" style="padding-top:230px;">
            <img src="images/loading.gif">
        </center>
      </div>
      <textarea id="xml" style="height:480px;width:684px;display:none;border-style:none;"></textarea>
      <span style="float:right;padding-right:36px;">
        <input id="source" type="checkbox"/>Source
      </span>
      <div id="footer">
          <p id="status">
              <!-- Status Here -->Loading...
          </p>
          <br/>
      </div>
    </div>

  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'content-process-editor',

      properties: {
        identityNodeId: {
          type: Number,
          value: 0,
          notify: true
        },

        versionValidityDate: {
          type: Number,
          value: undefined,
          notify: true
        }

      },

      edit: function(event) {
        this.fire('edit', event.model.item);
      },

      delete: function(event) {
        this.$.deleteRequest.url = "/content/delete";
        this.$.deleteRequest.params = {"id": event.model.item.identityNode._id};
        this.$.deleteRequest.generateRequest();
      },

      deleteResponse: function(request) {
      },

      refresh: function() {
        this.$.getChildren.generateRequest();
      },

      _updateChildren: function(event) {
        //this.main(this.$.graphContainer);
        new this.mxApplication('/polymer-starter-kit/app/elements/mxgraph-import/mxgraph/config/diagrameditor.xml');
      },

      // Program starts here. Creates a sample graph in the
      // DOM node with the specified ID. This function is invoked
      // from the onLoad event handler of the document (see below).
      main: function(container) {

        // Show mxLog for debugging
        //mxLog.show();

        // Creates the graph inside the given container
        //var model = new mxGraphModel();
        //var graph = new mxGraph(container, model);
        //var model = graph.getModel();
        

        // Load the configuration (e.g. stylesheet)
        // var configReq = mxUtils.load('/polymer-starter-kit/app/elements/mxgraph-import/mxgraph/config/stylesheet.xml'),
        //     configRoot = configReq.getDocumentElement(),
        //     configDecoder = new mxCodec(configRoot.ownerDocument);
        // configDecoder.decode(configRoot, graph);
        mxObjectCodec.allowEval = true;
        var config = mxUtils.load('/polymer-starter-kit/app/elements/mxgraph-import/mxgraph/config/diagrameditor.xml').getDocumentElement();
        var editor = new mxEditor(config);
        mxObjectCodec.allowEval = false;

        editor.setGraphContainer(container);

        var graph = editor.graph;
        var model = graph.model;

        // Enables rubberband selection
        new mxRubberband(graph);

        // Gets the default parent for inserting new cells. This
        // is normally the first child of the root (ie. layer 0).
        var parent = graph.getDefaultParent();

        // Adds cells to the model in a single step
        model.beginUpdate();
        try
        {
           for (var i = this.children.length - 1; i >= 0; i--) {
             var child = this.children[i];
             console.log(child);
             var contentType = child.contentType;
             if(contentType !== 'actor') {
              //continue;
             }

            var xml = child.mxCell.properties.properties.xml;
            var doc = mxUtils.parseXml(xml);
            var codec = new mxCodec(doc);
            var elt = doc.documentElement;
            var mxCell = codec.decode(elt);
            mxCell.setValue(child.name);
            console.log(mxCell);

            var cell = graph.addCell(mxCell, parent);

            //var cell = graph.insertVertex(parent, child.id, child.name, 20, 20, 80, 30, contentType);
             //cell.setGeometry({x: 20, y: 20, width: 80, height: 30, relative: false})
             //console.log(cell.getGeometry());

              // var encoder = new mxCodec();
              // var node = encoder.encode(cell.getGeometry());
              // console.log(mxUtils.getXml(node));

              

          };

          console.log(graph);

          //graph.insertEdge(parent, null, '', 6427, 6417);
        
          graph.refresh();

        }
        finally
        {
           // Updates the display
           model.endUpdate();
        }
      },

      /**
     * Constructs a new application (note that this returns an mxEditor
     * instance).
     */
      mxApplication: function(config) {

          var hideSplash = function() {
            // Fades-out the splash screen
            var splash = document.getElementById('splash');
            
            if (splash != null)
            {
              try
              {
                mxEvent.release(splash);
                mxEffects.fadeOut(splash, 100, true);
              }
              catch (e)
              {
                splash.parentNode.removeChild(splash);
              }
            }
          };
          
          try
          {
            if (!mxClient.isBrowserSupported())
            {
              mxUtils.error('Browser is not supported!', 200, false);
            }
            else
            {
              mxObjectCodec.allowEval = true;
              var node = mxUtils.load(config).getDocumentElement();
              var editor = new mxEditor(node);
              mxObjectCodec.allowEval = false;
              
              // Updates the window title after opening new files
              var title = document.title;
              var funct = function(sender)
              {
                document.title = title + ' - ' + sender.getTitle();
              };
              
              editor.addListener(mxEvent.OPEN, funct);
              
              // Prints the current root in the window title if the
              // current root of the graph changes (drilling).
              editor.addListener(mxEvent.ROOT, funct);
              funct(editor);
              
              // Displays version in statusbar
              editor.setStatus('mxGraph '+mxClient.VERSION);

              // Shows the application
              hideSplash();
            }
          }
          catch (e)
          {
            hideSplash();

            // Shows an error message if the editor cannot start
            mxUtils.alert('Cannot start application: '+e.message);
            throw e; // for debugging
          }

          // ON INIT
          // Enables rotation handle
          mxVertexHandler.prototype.rotationEnabled = true;

          // Enables guides
          mxGraphHandler.prototype.guidesEnabled = true;
          
          // Alt disables guides
          mxGuide.prototype.isEnabledForEvent = function(evt)
          {
            return !mxEvent.isAltDown(evt);
          };
          
          // Enables snapping waypoints to terminals
          mxEdgeHandler.prototype.snapToTerminals = true;
          
          // Defines an icon for creating new connections in the connection handler.
          // This will automatically disable the highlighting of the source vertex.
          mxConnectionHandler.prototype.connectImage = new mxImage('polymer-starter-kit/app/elements/mxgraph-import/mxgraph/images/connector.gif', 16, 16);
          
          // Enables connections in the graph and disables
          // reset of zoom and translate on root change
          // (ie. switch between XML and graphical mode).
          editor.graph.setConnectable(true);

          // Clones the source if new connection has no target
          editor.graph.connectionHandler.setCreateTarget(true);
          
          // Displays information about the session
          // in the status bar
          editor.addListener(mxEvent.SESSION, function(editor, evt)
          {
            var session = evt.getProperty('session');
            
            if (session.connected)
            {
              var tstamp = new Date().toLocaleString();
              editor.setStatus(tstamp+':'+
                ' '+session.sent+' bytes sent, '+
                ' '+session.received+' bytes received');
            }
            else
            {
              editor.setStatus('Not connected');
            }
          });
          
          // Updates the title if the root changes
          var title = document.getElementById('title');
          
          if (title != null)
          {
            var f = function(sender)
            {
              title.innerHTML = 'mxDraw - ' + sender.getTitle();
            };
            
            editor.addListener(mxEvent.ROOT, f);
            f(editor);
          }
          
            // Changes the zoom on mouseWheel events
            mxEvent.addMouseWheelListener(function (evt, up)
            {
              if (!mxEvent.isConsumed(evt))
              {
                if (up)
              {
                  editor.execute('zoomIn');
              }
              else
              {
                editor.execute('zoomOut');
              }
              
              mxEvent.consume(evt);
              }
            });

          // Defines a new action to switch between
          // XML and graphical display
          var textNode = document.getElementById('xml');
          var graphNode = editor.graph.container;
          var sourceInput = document.getElementById('source');
          sourceInput.checked = false;

          var funct = function(editor)
          {
            if (sourceInput.checked)
            {
              graphNode.style.display = 'none';
              textNode.style.display = 'inline';
              
              var enc = new mxCodec();
              var node = enc.encode(editor.graph.getModel());
              
              textNode.value = mxUtils.getPrettyXml(node);
              textNode.originalValue = textNode.value;
              textNode.focus();
            }
            else
            {
              graphNode.style.display = '';
              
              if (textNode.value != textNode.originalValue)
              {
                var doc = mxUtils.parseXml(textNode.value);
                var dec = new mxCodec(doc);
                dec.decode(doc.documentElement, editor.graph.getModel());
              }

              textNode.originalValue = null;
              
              // Makes sure nothing is selected in IE
              if (mxClient.IS_IE)
              {
                mxUtils.clearSelection();
              }

              textNode.style.display = 'none';

              // Moves the focus back to the graph
              textNode.blur();
              editor.graph.container.focus();
            }
          };
          
          editor.addAction('switchView', funct);
          
          // Defines a new action to switch between
          // XML and graphical display
          mxEvent.addListener(sourceInput, 'click', function()
          {
            editor.execute('switchView');
          });

          // Create select actions in page
          var node = document.getElementById('mainActions');
          var buttons = ['group', 'ungroup', 'cut', 'copy', 'paste', 'delete', 'undo', 'redo', 'print', 'show'];
          
          // Only adds image and SVG export if backend is available
          // NOTE: The old image export in mxEditor is not used, the urlImage is used for the new export.
          if (editor.urlImage != null)
          {
            // Client-side code for image export
            var exportImage = function(editor)
            {
              var graph = editor.graph;
              var scale = graph.view.scale;
              var bounds = graph.getGraphBounds();
              
                  // New image export
              var xmlDoc = mxUtils.createXmlDocument();
              var root = xmlDoc.createElement('output');
              xmlDoc.appendChild(root);
              
                // Renders graph. Offset will be multiplied with state's scale when painting state.
              var xmlCanvas = new mxXmlCanvas2D(root);
              xmlCanvas.translate(Math.floor(1 / scale - bounds.x), Math.floor(1 / scale - bounds.y));
              xmlCanvas.scale(scale);
              
              var imgExport = new mxImageExport();
                imgExport.drawState(graph.getView().getState(graph.model.root), xmlCanvas);
                
              // Puts request data together
              var w = Math.ceil(bounds.width * scale + 2);
              var h = Math.ceil(bounds.height * scale + 2);
              var xml = mxUtils.getXml(root);
              
              // Requests image if request is valid
              if (w > 0 && h > 0)
              {
                var name = 'export.png';
                var format = 'png';
                var bg = '&bg=#FFFFFF';
                
                new mxXmlRequest(editor.urlImage, 'filename=' + name + '&format=' + format +
                      bg + '&w=' + w + '&h=' + h + '&xml=' + encodeURIComponent(xml)).
                      simulate(document, '_blank');
              }
            };
            
            editor.addAction('exportImage', exportImage);
            
            // Client-side code for SVG export
            var exportSvg = function(editor)
            {
              var graph = editor.graph;
              var scale = graph.view.scale;
              var bounds = graph.getGraphBounds();

                // Prepares SVG document that holds the output
                var svgDoc = mxUtils.createXmlDocument();
                var root = (svgDoc.createElementNS != null) ?
                  svgDoc.createElementNS(mxConstants.NS_SVG, 'svg') : svgDoc.createElement('svg');
                
              if (root.style != null)
              {
                root.style.backgroundColor = '#FFFFFF';
              }
              else
              {
                root.setAttribute('style', 'background-color:#FFFFFF');
              }
                
                if (svgDoc.createElementNS == null)
                {
                  root.setAttribute('xmlns', mxConstants.NS_SVG);
                }
                
                root.setAttribute('width', Math.ceil(bounds.width * scale + 2) + 'px');
                root.setAttribute('height', Math.ceil(bounds.height * scale + 2) + 'px');
                root.setAttribute('xmlns:xlink', mxConstants.NS_XLINK);
                root.setAttribute('version', '1.1');
                
                // Adds group for anti-aliasing via transform
                var group = (svgDoc.createElementNS != null) ?
                    svgDoc.createElementNS(mxConstants.NS_SVG, 'g') : svgDoc.createElement('g');
              group.setAttribute('transform', 'translate(0.5,0.5)');
              root.appendChild(group);
                svgDoc.appendChild(root);

                // Renders graph. Offset will be multiplied with state's scale when painting state.
                var svgCanvas = new mxSvgCanvas2D(group);
                svgCanvas.translate(Math.floor(1 / scale - bounds.x), Math.floor(1 / scale - bounds.y));
                svgCanvas.scale(scale);
                
                var imgExport = new mxImageExport();
                imgExport.drawState(graph.getView().getState(graph.model.root), svgCanvas);

              var name = 'export.svg';
                var xml = encodeURIComponent(mxUtils.getXml(root));
              
              new mxXmlRequest(editor.urlEcho, 'filename=' + name + '&format=svg' + '&xml=' + xml).simulate(document, "_blank");
            };
            
            editor.addAction('exportSvg', exportSvg);
            
            buttons.push('exportImage');
            buttons.push('exportSvg');
          };
          
          for (var i = 0; i < buttons.length; i++)
          {
            var button = document.createElement('button');
            mxUtils.write(button, mxResources.get(buttons[i]));
          
            var factory = function(name)
            {
              return function()
              {
                editor.execute(name);
              };
            };
          
            mxEvent.addListener(button, 'click', factory(buttons[i]));
            node.appendChild(button);
          }

          // Create select actions in page
          var node = document.getElementById('selectActions');
          mxUtils.write(node, 'Select: ');
          mxUtils.linkAction(node, 'All', editor, 'selectAll');
          mxUtils.write(node, ', ');
          mxUtils.linkAction(node, 'None', editor, 'selectNone');
          mxUtils.write(node, ', ');
          mxUtils.linkAction(node, 'Vertices', editor, 'selectVertices');
          mxUtils.write(node, ', ');
          mxUtils.linkAction(node, 'Edges', editor, 'selectEdges');

          // Create select actions in page
          var node = document.getElementById('zoomActions');
          mxUtils.write(node, 'Zoom: ');
          mxUtils.linkAction(node, 'In', editor, 'zoomIn');
          mxUtils.write(node, ', ');
          mxUtils.linkAction(node, 'Out', editor, 'zoomOut');
          mxUtils.write(node, ', ');
          mxUtils.linkAction(node, 'Actual', editor, 'actualSize');
          mxUtils.write(node, ', ');
          mxUtils.linkAction(node, 'Fit', editor, 'fit');

          //window.onbeforeunload = function() { return mxResources.get('changesLost'); };
                   
          return editor;

      },


      _toArray: function(obj) {
        if(!obj) return;
        return Object.keys(obj).map(function(key) {
            return {
                name: key,
                value: obj[key]
            };
        });
      }


    });
  })();
  </script>
</dom-module>
